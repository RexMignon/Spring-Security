<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth2 Github 登录</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* 使内容和页脚在垂直方向上两端对齐 */
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f4f4;
            color: #333;
            text-align: center;
        }
        .main-content {
            flex-grow: 1; /* 占据剩余空间 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin-bottom: 20px;
            max-width: 600px; /* 限制容器宽度 */
            width: 90%;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .login-button-container, .welcome-section-header {
            display: flex;
            align-items: center;
            justify-content: center; /* 居中按钮和图标 */
            gap: 10px;
            margin-bottom: 15px;
        }
        .github-icon {
            width: 24px;
            height: 24px;
            vertical-align: middle;
        }
        button {
            background-color: #333;
            color: #fff;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 5px;
        }
        button:hover {
            background-color: #555;
        }
        #protectedContent {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #e9e9e9;
            width: 80%;
            max-width: 500px;
            text-align: left;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        #jwtInfo {
            margin-top: 10px;
            font-size: 0.9em;
            word-break: break-all; /* 确保长Token能够换行 */
            text-align: left;
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
        }
        pre { /* 用于美化 JSON 打印 */
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto; /* 水平滚动条 */
            white-space: pre-wrap; /* 自动换行 */
        }
        .footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ccc; /* 细线隔开 */
            color: #666;
            font-size: 0.85em;
            width: 90%;
            max-width: 600px;
            text-align: center;
        }
    </style>
</head>
<body>
<div class="main-content">
    <div class="container">
        <h1 id="welcomeMessage"></h1>
        <div id="authSection">
            <p>请选择以下方式登录：</p>
            <div class="login-button-container">
                <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub Logo" class="github-icon">
                <a href="/oauth2/authorization/github">
                    <button>使用 GitHub 登录</button>
                </a>
            </div>
        </div>
        <div id="loggedInSection" style="display: none;">
            <div class="welcome-section-header">
                <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub Logo" class="github-icon">
                <p id="loggedInWelcome"></p>
            </div>
            <p>您已获取 JWT Token:</p>
            <div id="jwtInfo"></div>
            <button onclick="logout()">退出登录</button>
        </div>
    </div>

    <div id="protectedContent">
        <h2>接口返回:</h2>
        <pre id="dataDisplay">...</pre>
    </div>
</div>

<footer class="footer">
    Copyright &copy; 2025 Mignon. All rights reserved.
</footer>

<script>
    const AUTH_TOKEN_KEY = 'yourAppJwt';

    document.addEventListener('DOMContentLoaded', function() {
        handleOAuth2Callback();
        checkLoginStatus();
    });

    function handleOAuth2Callback() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const usernameFromUrl = urlParams.get('username'); // 获取 username 参数

        if (token) {
            localStorage.setItem(AUTH_TOKEN_KEY, token);
            // 将用户名也存储起来，以便刷新页面后也能显示
            localStorage.setItem('githubUsername', usernameFromUrl || '未知用户');
            console.log('JWT Token and username received from URL and stored.');

            // 清理 URL 参数，移除 ?token=xxx&username=xxx
            const newUrl = window.location.origin + window.location.pathname;
            window.history.replaceState({}, document.title, newUrl);
        }
    }

    async function checkLoginStatus() {
        const token = localStorage.getItem(AUTH_TOKEN_KEY);
        const username = localStorage.getItem('githubUsername'); // 从 localStorage 获取用户名

        const authSection = document.getElementById('authSection');
        const loggedInSection = document.getElementById('loggedInSection');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const jwtInfoElement = document.getElementById('jwtInfo');
        const loggedInWelcomeElement = document.getElementById('loggedInWelcome');
        const dataDisplayElement = document.getElementById('dataDisplay');
        const protectedContentDiv = document.getElementById('protectedContent');

        if (token) {
            // 用户已登录或刚刚登录
            authSection.style.display = 'none';
            loggedInSection.style.display = 'block';
            welcomeMessage.textContent = '欢迎回来！';
            loggedInWelcomeElement.innerHTML = `GitHub 用户 <span style="font-weight: bold; color: #007bff;">${username || '未知用户'}</span> 欢迎回来！`;
            jwtInfoElement.textContent = token; // 显示 JWT Token

            // 自动请求 /success 接口
            try {
                // 请确保你的后端 /success 接口可以接收并验证此 Token
                const response = await fetch('/success', {
                    method: 'GET',
                    headers: {
                        'Authorization': token // 直接发送 Token，不加 'Bearer '
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    dataDisplayElement.innerHTML = `已通过 <span style="font-weight: bold;">[User]</span> 权限获取 Success 的访问内容:\n<pre>${JSON.stringify(data, null, 2)}</pre>`;
                    dataDisplayElement.classList.remove('error');
                    protectedContentDiv.style.display = 'block';
                } else {
                    const errorText = await response.text();
                    dataDisplayElement.textContent = `访问 Success 页面失败: ${response.status} - ${errorText}`;
                    dataDisplayElement.classList.add('error');
                    protectedContentDiv.style.display = 'block';
                    if (response.status === 401 || response.status === 403) {
                        logout();
                        alert('登录过期或权限不足，请重新登录。');
                    }
                }
            } catch (error) {
                console.error('Fetch error:', error);
                dataDisplayElement.textContent = `网络请求错误: ${error.message}`;
                dataDisplayElement.classList.add('error');
                protectedContentDiv.style.display = 'block';
            }

        } else {
            // 用户未登录
            authSection.style.display = 'block';
            loggedInSection.style.display = 'none';
            welcomeMessage.textContent = '欢迎来到我的应用！';
            protectedContentDiv.style.display = 'none';
        }
    }

    function logout() {
        localStorage.removeItem(AUTH_TOKEN_KEY); // 从 localStorage 移除 Token
        localStorage.removeItem('githubUsername'); // 移除用户名
        alert('您已成功退出登录！');
        checkLoginStatus(); // 更新页面状态，显示登录按钮
        document.getElementById('dataDisplay').textContent = '...'; // 清空数据
    }
</script>
</body>
</html>